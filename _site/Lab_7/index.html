<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Lab 7 | Liam Kain - ECE-4160</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Lab 7" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This is the documentation for what I have completed in ECE-4160" />
<meta property="og:description" content="This is the documentation for what I have completed in ECE-4160" />
<link rel="canonical" href="http://localhost:4000/Lab_7/" />
<meta property="og:url" content="http://localhost:4000/Lab_7/" />
<meta property="og:site_name" content="Liam Kain - ECE-4160" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Lab 7" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"This is the documentation for what I have completed in ECE-4160","headline":"Lab 7","url":"http://localhost:4000/Lab_7/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Liam Kain - ECE-4160" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Liam Kain - ECE-4160</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/Lab_1/">Lab 1</a><a class="page-link" href="/Lab_2/">Lab 2</a><a class="page-link" href="/Lab_3/">Lab 3</a><a class="page-link" href="/Lab_4/">Lab 4</a><a class="page-link" href="/Lab_5/">Lab 5</a><a class="page-link" href="/Lab_6/">Lab 6</a><a class="page-link" href="/Lab_7/">Lab 7</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Lab 7</h1>
  </header>

  <div class="post-content">
    <p>In this lab, PID control was implemented on the artemis in order to simulate the simplest control using one of the sensors on the robot.</p>

<h3 id="estimate-drag-and-momentum">Estimate Drag and Momentum</h3>

<p>To estimate drag and momentum, as said in class,</p>

\[d = \frac{u}{\text{steady state derivative}}\]

<p>and</p>

\[m = \frac{d t_{0.9}}{ln(1s-.9s)}\]

<p>where d and m are the drag and mass respectively.</p>

<p>To find this, I used a constant step response towards a wall at 
a pwm value of 200 since this was the maximum pwm value from my pid trials. Doing a step response resulted in this time of flight data.</p>

<p><img src="../images/step.png" alt="Italian Trulli" width="100%" /></p>

<p>As seen from the graph, between the two marked points, the speed reaches steady state at a derivative of about 22613mm/s</p>

<p>Looking at the graph, the 90% rise time was about .8s.
Therefore,</p>

\[d = \frac{u}{\text{22613mm/s}} \approx 0.000383\]

\[m = \frac{0.000383 * .8s}{ln(1s-.9s)} \approx 0.0001329\]

<p>Now, the A and B matrices are given by</p>

\[A = \begin{bmatrix} 0 &amp; 1 \\  0 &amp; -\frac{d}{m} \end{bmatrix} = \begin{bmatrix} 0 &amp; 1 \\  0 &amp; -2.88 \end{bmatrix}\]

\[B = \begin{bmatrix} 0 \\ \frac{1}{m} \end{bmatrix} = \begin{bmatrix} 0 \\ -60175 \end{bmatrix}\]

\[C = \begin{bmatrix} -1 &amp; 0 \end{bmatrix}\]

<h3 id="initialize-kf">Initialize KF</h3>

<p>For discretizing the previously computed matrices, I needed a chosen sample rate
to predict filter values at, I chose a sample rate of 15ms, so 
To discretize these matrices, the formula is</p>

\[A_d = (I + dt*A) = \begin{bmatrix} 1 &amp; 0.015 \\  0 &amp; 0.957 \end{bmatrix}\]

\[B_d = dt*B = \begin{bmatrix} 0 \\  -902.7 \end{bmatrix}\]

<p>Next, I needed to</p>

<p>Estimate the noise variables, sigma_u and sigma_z.</p>

\[\Sigma_z = \begin{bmatrix} \sigma_z^2 \end{bmatrix}\]

\[\Sigma_u = \begin{bmatrix} \sigma_x^2 &amp; 0\\  0 &amp; \sigma_v^2 \end{bmatrix}\]

<p>to find these variables,
from class,</p>

\[\sigma_z = \sigma_{TOF} \approx 20mm\]

<p>also,</p>

\[\sigma_x = \sigma_v = \sqrt{10^2 * \frac{1}{dt}} \approx 81\]

<p>,so</p>

\[\Sigma_z = \begin{bmatrix} 20^2 \end{bmatrix}\]

\[\Sigma_u = \begin{bmatrix} 81^2 &amp; 0\\  0 &amp; 81^2 \end{bmatrix}\]

<p>with these values worked out, I could finally create the kalman filter using the function given in class.
Since my code is identical to the given code, here is my matrix creation and calling of the function.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>u= np.array([[dist[0]],[0]])
sigma = Sigma_u
for t,mo,d in zip(times,motor,dist):
    u,sigma = kf(u,sigma,mo/200,d)
    kf_times.append(t + time*dt) 
    kf_out.append(u[0][0])
    kf_vel.append(u[1][0])
</code></pre></div></div>

<p>resulting in this graph</p>

<p><img src="../images/kf_python.png" alt="Italian Trulli" width="100%" /></p>

<p>As can be seen, the kalman filter successfully follows the outline of the data allowing me to effectively predict the next
TOF point. I used a sampling rate of 95ms since this was the sampling rate of the sensors.</p>

<h3 id="kalman-filter-on-artemis">Kalman filter on artemis</h3>

<p>I then had to implement this filter in arduino. I implemented the kalman filter on arduino like this.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>inline void kf(Matrix&lt;2&gt; &amp;mu, Matrix&lt;2, 2&gt; &amp;sigma, Matrix&lt;1&gt; u, Matrix&lt;1&gt; y, bool update)
{
    Matrix&lt;2&gt; mu_p = (A * mu) + (B * u);
    Matrix&lt;2, 2&gt; sigma_p = A * (sigma * (~A)) + Sigma_u;
    if (update)
    {
        Matrix&lt;1, 1&gt; sigma_m = C * (sigma_p * ~C) + Sigma_z;
        Matrix&lt;1, 1&gt; sigma_m_inv;
        bool inv = Invert(sigma_m, sigma_m_inv);
        Matrix&lt;2, 1&gt; kkf_gain = sigma_p * ((~C) * sigma_m_inv);

        Matrix&lt;1, 1&gt; y_m = y - C * mu_p;
        mu = mu_p + kkf_gain * y_m;
        sigma = eye_2 - kkf_gain * (C)*sigma_p;
    }
    else
    {
    mu = mu_p;
    sigma = sigma_p;
    }
}
</code></pre></div></div>

<p>I then had to modify my PID loop from Lab 6. What I did was wait my sampling time (15ms) and if
the time of flight sensor had data,</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    if (dist1Buff[cnt] != 4000)
        kf(state, sigma, float(motorBuff[cnt]) / 200, dist1Buff[cnt], true);
    else
        kf(state, sigma, float(motorBuff[cnt]) / 200, dist1Buff[cnt], false);
    kfBuff[cnt] = state(0);
</code></pre></div></div>

<p>but if there was no data</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    kf(state, sigma, float(motorBuff[cnt]) / 200, dist1Buff[cnt], false);
    dist1Buff[cnt] = -1;
    kfBuff[cnt] = state(0);
</code></pre></div></div>

<p>Then, I would call my PID function with the value of state(0). With this done, I finally tested this
filter on the robot resulting in this trial,</p>

<video width="100%" controls="">
  <source src="../videos/kf.webm" type="video/webm" />
  Your browser does not support the video tag.
</video>

<p>and this data</p>

<p><img src="../images/trial_kf_1_distance.png" alt="Italian Trulli" width="100%" /></p>

<p><img src="../images/trial_kf_1_motor.png" alt="Italian Trulli" width="100%" /></p>

<p>the first value after collecting sensor data is too high and slowly fixes itself as it moves closer to the next data collection. Since I
had a high Kd value in my PID loop, the noise in the motor value graph is probably due to the cascaded kalmar filter output.</p>

<h3 id="revisiting-python-model">Revisiting python model</h3>
<p>I had to modify certain values in the B matrix as the motor values didnâ€™t have as much of an effect on the kalman filter output as expected. Because my data was positive, I needed to make the C matrix equal to [1 0] instead of [-1 0]. I also needed to make my B matrix You can see that the output is tiered as my B matrix was still not steep enough. I reran my python program attempting to add in a prediction step in order to better analyze my kalman filter model resulting in this data.</p>

<p><img src="../images/kf_python_fixed.png" alt="Italian Trulli" width="100%" /></p>

<p>I had to increase the B matrix values by about 3 times, I also had to make the value negative. This is probably because of my positive distance values
as well as a mass value that was larger than expected.</p>

<p>The code I used to produce this data was like this,</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    for t,mo,d in zip(times,motor,dist):
        for time in range(int(tot_dt/dt)):
            if time == 0:
            u,sigma = kf(u,sigma,mo/200,d)
            else:
            u,sigma = kf(u,sigma,mo/200,-1)
            pass
            kf_times.append(t + time*dt) 
            kf_out.append(u[0][0])
            kf_vel.append(u[1][0])
</code></pre></div></div>

<p>As can be seen, with modifications to the python code, the cascaded nature of the filter is seen with a small sample period.</p>


  </div>

</article>

<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Liam Kain - ECE-4160</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Liam Kain - ECE-4160</li><li><a class="u-email" href="mailto:ljk74@cornell.edu">ljk74@cornell.edu</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/lk1007"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">lk1007</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>This is the documentation for what I have completed in ECE-4160</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
