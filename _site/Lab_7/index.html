<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Lab 7 - ECE-4160</title>
<meta name="description" content="This is the documentation for what I have completed in ECE-4160">


  <meta name="author" content="Liam Kain">
  


<meta property="og:type" content="website">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="ECE-4160">
<meta property="og:title" content="Lab 7">
<meta property="og:url" content="http://localhost:4000/Lab_7/">


  <meta property="og:description" content="This is the documentation for what I have completed in ECE-4160">












<link rel="canonical" href="http://localhost:4000/Lab_7/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "http://localhost:4000/"
    
  }
</script>







<!-- end _includes/seo.html -->




<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          ECE-4160
          
        </a>
        <ul class="visible-links"></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="http://localhost:4000/">
        <img src="/images/LiamKain.JPG" alt="Liam Kain" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="http://localhost:4000/" itemprop="url">Liam Kain</a>
    </h3>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle Menu</label>
  <ul class="nav__items">
    
      <li>
        
          <a href="/Lab_1/"><span class="nav__sub-title">Lab 1</span></a>
        

        
      </li>
    
      <li>
        
          <a href="/Lab_2/"><span class="nav__sub-title">Lab 2</span></a>
        

        
      </li>
    
      <li>
        
          <a href="/Lab_3/"><span class="nav__sub-title">Lab 3</span></a>
        

        
      </li>
    
      <li>
        
          <a href="/Lab_4/"><span class="nav__sub-title">Lab 4</span></a>
        

        
      </li>
    
      <li>
        
          <a href="/Lab_5/"><span class="nav__sub-title">Lab 5</span></a>
        

        
      </li>
    
      <li>
        
          <a href="/Lab_6/"><span class="nav__sub-title">Lab 6</span></a>
        

        
      </li>
    
      <li>
        
          <a href="/Lab_7/"><span class="nav__sub-title">Lab 7</span></a>
        

        
      </li>
    
  </ul>
</nav>

    
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Lab 7">
    
    
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Lab 7
</h1>
          


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu"><li><a href="#estimate-drag-and-momentum">Estimate Drag and Momentum</a></li><li><a href="#initialize-kf">Initialize KF</a></li><li><a href="#kalman-filter-on-artemis">Kalman filter on artemis</a></li><li><a href="#revisiting-python-model">Revisiting python model</a></li></ul>

            </nav>
          </aside>
        
        <p>In this lab, PID control was implemented on the artemis in order to simulate the simplest control using one of the sensors on the robot.</p>

<h3 id="estimate-drag-and-momentum">Estimate Drag and Momentum</h3>

<p>To estimate drag and momentum, as said in class,</p>

\[d = \frac{u}{\text{steady state derivative}}\]

<p>and</p>

\[m = \frac{d t_{0.9}}{ln(1s-.9s)}\]

<p>where d and m are the drag and mass respectively.</p>

<p>To find this, I used a constant step response towards a wall at 
a pwm value of 200 since this was the maximum pwm value from my pid trials. Doing a step response resulted in this time of flight data.</p>

<p><img src="../images/step.png" alt="Italian Trulli" width="100%" /></p>

<p>As seen from the graph, between the two marked points, the speed reaches steady state at a derivative of about 22613mm/s</p>

<p>Looking at the graph, the 90% rise time was about .8s.
Therefore,</p>

\[d = \frac{u}{\text{22613mm/s}} \approx 0.000383\]

\[m = \frac{0.000383 * .8s}{ln(1s-.9s)} \approx 0.0001329\]

<p>Now, the A and B matrices are given by</p>

\[A = \begin{bmatrix} 0 &amp; 1 \\  0 &amp; -\frac{d}{m} \end{bmatrix} = \begin{bmatrix} 0 &amp; 1 \\  0 &amp; -2.88 \end{bmatrix}\]

\[B = \begin{bmatrix} 0 \\ \frac{1}{m} \end{bmatrix} = \begin{bmatrix} 0 \\ -60175 \end{bmatrix}\]

\[C = \begin{bmatrix} -1 &amp; 0 \end{bmatrix}\]

<h3 id="initialize-kf">Initialize KF</h3>

<p>For discretizing the previously computed matrices, I needed a chosen sample rate
to predict filter values at, I chose a sample rate of 15ms, so 
To discretize these matrices, the formula is</p>

\[A_d = (I + dt*A) = \begin{bmatrix} 1 &amp; 0.015 \\  0 &amp; 0.957 \end{bmatrix}\]

\[B_d = dt*B = \begin{bmatrix} 0 \\  -902.7 \end{bmatrix}\]

<p>Next, I needed to</p>

<p>Estimate the noise variables, sigma_u and sigma_z.</p>

\[\Sigma_z = \begin{bmatrix} \sigma_z^2 \end{bmatrix}\]

\[\Sigma_u = \begin{bmatrix} \sigma_x^2 &amp; 0\\  0 &amp; \sigma_v^2 \end{bmatrix}\]

<p>to find these variables,
from class,</p>

\[\sigma_z = \sigma_{TOF} \approx 20mm\]

<p>also,</p>

\[\sigma_x = \sigma_v = \sqrt{10^2 * \frac{1}{dt}} \approx 81\]

<p>,so</p>

\[\Sigma_z = \begin{bmatrix} 20^2 \end{bmatrix}\]

\[\Sigma_u = \begin{bmatrix} 81^2 &amp; 0\\  0 &amp; 81^2 \end{bmatrix}\]

<p>with these values worked out, I could finally create the kalman filter using the function given in class.
Since my code is identical to the given code, here is my matrix creation and calling of the function.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>u= np.array([[dist[0]],[0]])
sigma = Sigma_u
for t,mo,d in zip(times,motor,dist):
    u,sigma = kf(u,sigma,mo/200,d)
    kf_times.append(t + time*dt) 
    kf_out.append(u[0][0])
    kf_vel.append(u[1][0])
</code></pre></div></div>

<p>resulting in this graph</p>

<p><img src="../images/kf_python.png" alt="Italian Trulli" width="100%" /></p>

<p>As can be seen, the kalman filter successfully follows the outline of the data allowing me to effectively predict the next
TOF point. I used a sampling rate of 95ms since this was the sampling rate of the sensors.</p>

<h3 id="kalman-filter-on-artemis">Kalman filter on artemis</h3>

<p>I then had to implement this filter in arduino. I implemented the kalman filter on arduino like this.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>inline void kf(Matrix&lt;2&gt; &amp;mu, Matrix&lt;2, 2&gt; &amp;sigma, Matrix&lt;1&gt; u, Matrix&lt;1&gt; y, bool update)
{
    Matrix&lt;2&gt; mu_p = (A * mu) + (B * u);
    Matrix&lt;2, 2&gt; sigma_p = A * (sigma * (~A)) + Sigma_u;
    if (update)
    {
        Matrix&lt;1, 1&gt; sigma_m = C * (sigma_p * ~C) + Sigma_z;
        Matrix&lt;1, 1&gt; sigma_m_inv;
        bool inv = Invert(sigma_m, sigma_m_inv);
        Matrix&lt;2, 1&gt; kkf_gain = sigma_p * ((~C) * sigma_m_inv);

        Matrix&lt;1, 1&gt; y_m = y - C * mu_p;
        mu = mu_p + kkf_gain * y_m;
        sigma = eye_2 - kkf_gain * (C)*sigma_p;
    }
    else
    {
    mu = mu_p;
    sigma = sigma_p;
    }
}
</code></pre></div></div>

<p>I then had to modify my PID loop from Lab 6. What I did was wait my sampling time (15ms) and if
the time of flight sensor had data,</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    if (dist1Buff[cnt] != 4000)
        kf(state, sigma, float(motorBuff[cnt]) / 200, dist1Buff[cnt], true);
    else
        kf(state, sigma, float(motorBuff[cnt]) / 200, dist1Buff[cnt], false);
    kfBuff[cnt] = state(0);
</code></pre></div></div>

<p>but if there was no data</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    kf(state, sigma, float(motorBuff[cnt]) / 200, dist1Buff[cnt], false);
    dist1Buff[cnt] = -1;
    kfBuff[cnt] = state(0);
</code></pre></div></div>

<p>Then, I would call my PID function with the value of state(0). With this done, I finally tested this
filter on the robot resulting in this trial,</p>

<video width="100%" controls="">
  <source src="../videos/kf.webm" type="video/webm" />
  Your browser does not support the video tag.
</video>

<p>and this data</p>

<p><img src="../images/trial_kf_1_distance.png" alt="Italian Trulli" width="100%" /></p>

<p><img src="../images/trial_kf_1_motor.png" alt="Italian Trulli" width="100%" /></p>

<p>the first value after collecting sensor data is too high and slowly fixes itself as it moves closer to the next data collection. Since I
had a high Kd value in my PID loop, the noise in the motor value graph is probably due to the cascaded kalmar filter output.</p>

<h3 id="revisiting-python-model">Revisiting python model</h3>
<p>I had to modify certain values in the B matrix as the motor values didnâ€™t have as much of an effect on the kalman filter output as expected. Because my data was positive, I needed to make the C matrix equal to [1 0] instead of [-1 0]. I also needed to make my B matrix You can see that the output is tiered as my B matrix was still not steep enough. I reran my python program attempting to add in a prediction step in order to better analyze my kalman filter model resulting in this data.</p>

<p><img src="../images/kf_python_fixed.png" alt="Italian Trulli" width="100%" /></p>

<p>I had to increase the B matrix values by about 3 times, I also had to make the value negative. This is probably because of my positive distance values
as well as a mass value that was larger than expected.</p>

<p>The code I used to produce this data was like this,</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    for t,mo,d in zip(times,motor,dist):
        for time in range(int(tot_dt/dt)):
            if time == 0:
            u,sigma = kf(u,sigma,mo/200,d)
            else:
            u,sigma = kf(u,sigma,mo/200,-1)
            pass
            kf_times.append(t + time*dt) 
            kf_out.append(u[0][0])
            kf_vel.append(u[1][0])
</code></pre></div></div>

<p>As can be seen, with modifications to the python code, the cascaded nature of the filter is seen with a small sample period.</p>


        
      </section>

      <footer class="page__meta">
        
        


        

      </footer>

      

      
    </div>

    
  </article>

  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2023 ECE-4160. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>










  </body>
</html>
