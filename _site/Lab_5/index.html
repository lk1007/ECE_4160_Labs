<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Lab 5 | Liam Kain - ECE-4160</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Lab 5" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This is the documentation for what I have completed in ECE-4160" />
<meta property="og:description" content="This is the documentation for what I have completed in ECE-4160" />
<link rel="canonical" href="http://localhost:4000/Lab_5/" />
<meta property="og:url" content="http://localhost:4000/Lab_5/" />
<meta property="og:site_name" content="Liam Kain - ECE-4160" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Lab 5" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"This is the documentation for what I have completed in ECE-4160","headline":"Lab 5","url":"http://localhost:4000/Lab_5/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Liam Kain - ECE-4160" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Liam Kain - ECE-4160</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/Lab_1/">Lab 1</a><a class="page-link" href="/Lab_2/">Lab 2</a><a class="page-link" href="/Lab_3/">Lab 3</a><a class="page-link" href="/Lab_4/">Lab 4</a><a class="page-link" href="/Lab_5/">Lab 5</a><a class="page-link" href="/Lab_6/">Lab 6</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Lab 5</h1>
  </header>

  <div class="post-content">
    <style> 
img {
  display: block;
  margin-left: auto;
  margin-right: auto;
}
video {
  display: block;
  margin-left: auto;
  margin-right: auto;
}
</style>

<p>In Lab5, the goal was to investigate and integrate the motor drivers into the existing robot system allowing the artemis to control the position of the robot.</p>
<h2 id="prelab">Prelab</h2>
<h3 id="wiring">Wiring</h3>

<p>In planning the wiring for this lab, a few things were taken into account. To get input to the motor drivers, pwm pins had to be used on the artemis. Looking at the schematic for the board, available pins for this task were pins 4,5,14,15. To attach the motor drivers, the inputs and outputs of the motor were driven in parallel since only two inputs were used, but 4 are given, so the driver’s inputs and outputs had to be soldered together. Another important question was how to connect power as there are two motor drivers to drive, but only two leads from the battery. The solution to this was to run a wire through VCC of one motor driver, solder the wire to the pad, and then solder a small wire from the other driver’s VCC pad to this wire. The same was done for ground.
To test the motor drivers. The result of these decisions is outlined in this high level diagram.</p>

<p><img src="../images/motor_driver_wiring.jpg" alt="Italian Trulli" width="140%" /></p>

<p>I soldered one of the motor drivers according to the previously explained diagram. After doing that, I hooked one of the
motor driver inputs to the oscilloscope and the VCC and ground of one of the motor drivers.</p>

<p><img src="../images/Oscilliscope_setup.jpg" alt="Italian Trulli" width="100%" /></p>

<h3 id="power-supply-setting">Power supply setting</h3>

<p>Since the battery that powers the motors works on 3.7V, a reasonable setting was 3.7-4.5V. I adjusted
the current compliance on the power supply until there was no voltage drop while the motors were running. This current
compliance ended up being about 2A.</p>

<h3 id="testing-motor-drivers">Testing motor drivers</h3>

<p>To test the motor drivers, I created a piece of code to run each input separately and 0 the other input.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>analogWrite(15, 0);
analogWrite(14, 195);
delay(1000);
analogWrite(14,0);
analogWrite(15,195);
delay(1000);
</code></pre></div></div>

<p>I would then run this code on the other driver’s inputs (GPIO 4 and 5) to test that driver.</p>

<p>Here is a picture of the oscilloscope when one of the motor driver inputs is being powered. As you can see, the amplitude is 3.12V. 3V is around the expected 3.3V coming from the GPIO pin and 
The duty cycle can also be seen as since the duty cycle was about 195/256, so the wave is mostly high for the duration of the period.</p>

<p><img src="../images/Oscilliscope.jpg" alt="Italian Trulli" width="100%" /></p>

<p>This video resulted from running the code.</p>

<video width="100%" controls="">
  <source src="../videos/One_side_wheel.webm" type="video/webm" />
  Your browser does not support the video tag.
</video>

<h3 id="spinning-both-motors">Spinning both motors</h3>

<p>The process was repeated for the other motor driver and as discussed in the prelab, I hooked up the VCC and ground pins of the motor driver together through the battery leads. I then connected the battery and ran my code for both motor drivers. To do this, I created a more compact function as well as a few macros. First I defined the motor inputs,</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#define FORWARD_MOTOR_1 15
#define BACKWARD_MOTOR_1 14
#define FORWARD_MOTOR_2 5
#define BACKWARD_MOTOR_2 2
</code></pre></div></div>

<p>I could then create an easy to use function, change_speed(), which would change the speed of each motor easily</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>void change_speed(int speed_1, int speed_2)
{
    if (speed_1 &gt; 0)
    {
        analogWrite(FORWARD_MOTOR_1, speed_1);
        analogWrite(BACKWARD_MOTOR_1, 0);
    }
    else
    {
        analogWrite(FORWARD_MOTOR_1, 0);
        analogWrite(BACKWARD_MOTOR_1, -speed_1);
    }
    if (speed_2 &gt; 0)
    {
        analogWrite(FORWARD_MOTOR_2, speed_2);
        analogWrite(BACKWARD_MOTOR_2, 0);
    }
    else
    {
        analogWrite(FORWARD_MOTOR_2, 0);
        analogWrite(BACKWARD_MOTOR_2, -speed_2);
    }
}
</code></pre></div></div>

<p>Then, I created a method, move, to add duration and the ability to choose between hard stopping and drifting after the movement was done.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>inline void move(int speed_1, int speed_2, int duration, bool hard_stop)
{
    change_speed(speed_1, speed_2);
    delay(duration);
    if (hard_stop)
    {
        analogWrite(FORWARD_MOTOR_1, 255);
        analogWrite(BACKWARD_MOTOR_1, 255);
        analogWrite(FORWARD_MOTOR_2, 255);
        analogWrite(BACKWARD_MOTOR_2, 255);
    }
    else
    {
        analogWrite(FORWARD_MOTOR_1, 0);
        analogWrite(BACKWARD_MOTOR_1, 0);
        analogWrite(FORWARD_MOTOR_2, 0);
        analogWrite(BACKWARD_MOTOR_2, 0);
    }
}
</code></pre></div></div>

<p>After this was done, I could finally code the example shown in this video with both wheels able to spin in both directions independently and together</p>

<video width="100%" controls="">
  <source src="../videos/Both_side_wheels.webm" type="video/webm" />
  Your browser does not support the video tag.
</video>
<p>This is the code the example in the video ran on</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>int speed_1 = 100;
int speed_2 = 100;

move(0,speed_2,1000,1);
move(0,-speed_2,1000,1);
move(speed_1,0,1000,1);
move(-speed_1,0,1000,1);
move(speed_1,speed_2,1000,1);
move(-speed_1,-speed_2,1000,1);
</code></pre></div></div>

<h3 id="final-assembly">Final Assembly</h3>

<p>With both of the motor drivers tested and integrated, here is a photo of the final assembly.
<img src="../images/components_in_car.jpg" alt="Italian Trulli" width="70%" /></p>

<h3 id="bluetooth-integration">Bluetooth Integration</h3>
<p>In order to discover the ranges of the pwm values available to use for driving the motors, I integrated the
motor drivers into the bluetooth code by adding a MOVE_LINE command. It works like this,</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>case MOVE_LINE:
    int speed1, speed2, time, stop_motor;
    success = robot_cmd.get_next_value(speed1);
    if (!success)
        return;
    success = robot_cmd.get_next_value(speed2);
    if (!success)
        return;
    success = robot_cmd.get_next_value(time);
    if (!success)
        return;
    success = robot_cmd.get_next_value(stop_motor);
    if (!success)
        return;
    // move_stunt();
    move(speed1, speed2, time, stop_motor);
    break;
</code></pre></div></div>

<p>Essentially sending any possible command to the move() method over bluetooth. I could also
replace the move() method with any other custom method and execute that instead.</p>

<h3 id="lower-pwm-threshold">Lower PWM Threshold</h3>

<p>With MOVE_LINE created, I could then investigate the lower limits of the pwm values that moved
the motors as when doing control theory later on, the output values to the motors should not
be below this lower pwm threshold.
To investigate this, I created a loop through various pwm values and sent them over bluetooth
like this.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for i in range(12):
  ble.send_command(CMD.MOVE_LINE,str(i*2+20) + "|" + str(i*2+20) + "|400")
  print("Speed: ", i*2+20)
</code></pre></div></div>

<p>This would start and stop the motor at each speed. After trial and error, I found
that the best interval to investigate this lower limit was pwm values 20-34. Resulting in
this video.</p>

<video width="40%" controls="">
  <source src="../videos/min_pwm.webm" type="video/webm" />
  Your browser does not support the video tag.
</video>

<p>in this video, you can see that the pwm value 22 is where the car wheels start to beat friction,
but they fully beat the kinetic friction at 24, so 22 is good enough to beat dynamic friction most likely
and 24 for static friction</p>

<h3 id="calibration">Calibration</h3>
<p>Since the motors don’t have the exact same torque output, they needed
to be calibrated in order to move both sides of the car equally.</p>

<p>Here is a video of the car attempting to move in a straight line uncalibrated.</p>
<video width="40%" controls="">
  <source src="../videos/uncalib.webm" type="video/webm" />
  Your browser does not support the video tag.
</video>
<p>As you can see, the robot veers left.</p>

<p>By using MOVE_LINE, to adjust the speed parameters, I found that multiplying the
left motor’s pwm value by 1.45 times the right motor pwm value was good, so this line was added to change_speed()</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>speed_1 = MOTOR_CORRECTION_FACTOR_1_to_2 * speed_1;
</code></pre></div></div>

<p>These two videos show the result as the robot moves in a straight line for 6 feet.</p>
<video width="80%" controls="">
  <source src="../videos/Straight_line.webm" type="video/webm" />
  Your browser does not support the video tag.
</video>
<p>This video shows the robot moving straight on the slippery floors just outside phillips.</p>
<video width="40%" controls="">
  <source src="../videos/more_straight_line.webm" type="video/webm" />
  Your browser does not support the video tag.
</video>

<h3 id="open-loop-control">Open Loop Control</h3>

<p>Finally, an open loop control stunt was created. This stunt involved moving straight, veering left,
veering right, spinning and then going straight,left, and right again. This is open loop control as there
is no feedback and the controller simply sends commands to the system.</p>

<p>Here is the code for this control,</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>int speed_1 = 75;
int speed_2 = speed_1;
move(speed_1, speed_2, 400, 0);
move(.2 * speed_1, speed_2, 800, 0);
move(speed_1, .2 * speed_2, 800, 0);
move(speed_1, .2 * speed_2, 800, 0);
move(-speed_1, speed_2, 1000, 0);
move(speed_1, speed_2, 400, 0);
move(.2 * speed_1, speed_2, 800, 0);
move(speed_1, .2 * speed_2, 800, 0);
</code></pre></div></div>

<p>Here is a video of the resulting control.</p>

<video width="40%" controls="">
  <source src="../videos/open_loop.webm" type="video/webm" />
  Your browser does not support the video tag.
</video>


  </div>

</article>

<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Liam Kain - ECE-4160</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Liam Kain - ECE-4160</li><li><a class="u-email" href="mailto:ljk74@cornell.edu">ljk74@cornell.edu</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/lk1007"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">lk1007</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>This is the documentation for what I have completed in ECE-4160</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
